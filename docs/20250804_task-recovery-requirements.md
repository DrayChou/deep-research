# Deep Research 任务恢复系统需求文档

## 核心需求

### 1. 任务复用机制
- **问题描述**: "目录为空才是最大的问题，同一个用户不停的发起同样的一个 live 请求"
- **解决目标**: 相同的请求参数应该复用已存在的任务，而不是创建新任务
- **预期行为**: 用户刷新页面或重新发起相同请求时，应该看到相同的任务ID和进度

### 2. 任务持久化存储
- **问题描述**: 任务数据需要在服务器重启、用户刷新后依然可用
- **存储要求**: 
  - 任务进度和状态要持久化保存
  - 任务结果要能够恢复和继续
  - 存储位置: `data/tasks/` 目录（项目根目录下）

### 3. 请求指纹匹配
- **匹配条件**: 基于以下参数生成唯一指纹
  - `query` - 查询内容
  - `enableCitationImage` - 是否启用引用图片
  - `enableReferences` - 是否启用参考文献
  - `AIProvider` - AI提供商配置（provider, thinkingModel, taskModel）
  - `searchProvider` - 搜索提供商配置（provider, maxResult）
  - `language` - 语言设置

### 4. 任务状态管理
- **任务状态**: running, paused, completed, failed
- **进度跟踪**: 百分比进度和当前执行步骤
- **恢复点**: 支持从不同阶段恢复任务执行

### 5. 缓存策略
- **重要原则**: "没必要设置清理任务，你是不是傻，缓存任务用户指不定多久才会继续进来继续任务"
- **缓存时长**: 无限期保存，不设置自动清理
- **用户场景**: 用户可能在很长时间后回来继续查看结果

## 技术要求

### 1. SSE兼容性
- **数据格式**: 保持纯文本格式，不发送JSON消息
- **兼容性**: 确保前端现有的SSE处理逻辑不受影响
- **测试URL**: `http://localhost:8080/dp2api/api/sse/live?query=...`

### 2. 文件系统操作
- **原子写入**: 使用临时文件 + rename 确保数据完整性
- **错误处理**: 妥善处理文件读写错误，避免数据丢失
- **路径解析**: 正确识别项目根目录，避免存储到错误位置

### 3. 性能考虑
- **启动速度**: 不应显著影响SSE接口的响应速度
- **内存使用**: 合理管理内存，避免内存泄漏
- **并发处理**: 支持多个并发请求的任务管理

## 实现约束

### 1. 最小化修改
- 优先在现有SSE route中实现，避免过度抽象
- 不引入复杂的依赖关系
- 保持代码简洁易维护

### 2. 错误容错
- 任务恢复失败时，应该能够从头开始执行
- 文件损坏时，应该能够自动修复或重新创建
- 网络中断时，任务状态应该正确保存

### 3. 调试友好
- 提供清晰的日志输出
- 便于问题定位和排查
- 支持开发环境的快速测试

## 用例场景

### 场景1: 首次请求
1. 用户发起新的research请求
2. 系统生成请求指纹
3. 未找到匹配任务，创建新任务
4. 执行research并保存进度

### 场景2: 重复请求
1. 用户刷新页面或重新发起相同请求
2. 系统计算请求指纹
3. 找到匹配的已完成任务
4. 直接返回之前的结果

### 场景3: 中断恢复
1. 用户请求执行中断（网络问题、服务器重启等）
2. 用户重新发起相同请求
3. 系统找到中断的任务
4. 从适当的恢复点继续执行

### 场景4: 长期恢复
1. 用户数天或数周后重新访问
2. 系统仍能找到之前的任务结果
3. 展示完整的历史结果

## 成功标准

1. **功能正确性**: 相同请求参数确实复用同一任务
2. **数据持久性**: 服务器重启后任务数据不丢失
3. **兼容性**: 不破坏现有前端功能
4. **性能**: 不显著增加响应时间
5. **可维护性**: 代码结构清晰，易于理解和修改