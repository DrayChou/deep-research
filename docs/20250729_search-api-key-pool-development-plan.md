# Search API Key Pool 开发计划

## 项目概述

为 deep-research 项目实现一个通用的搜索 API Key 池化功能，支持多个 API key 的智能轮询和失败管理。

## 需求分析

### 核心需求
1. **多 Key 支持**：将单个 API key 改为支持半角逗号分割的数组
2. **智能轮询**：从可用 key 池中智能选择，避免使用失效的 key
3. **失败处理**：当 API 返回 432 状态码或非200状态码时，标记 key 失效
4. **冷却机制**：失效的 key 标记一周内不能使用
5. **循环尝试**：优先使用其他可用 key，直到所有 key 都不可用才报错

### 扩展需求
- **通用化**：兼容所有搜索提供商（tavily、firecrawl、exa、bocha等）
- **最小化修改**：基于现有 `multiApiKeyPolling` 方法扩展，减少代码修改量

## 技术方案

### 核心设计
1. **全局状态管理**：使用全局变量存储各提供商的 key 使用状态
2. **Key 反查机制**：通过 key 反查对应的 provider，无需修改函数参数
3. **智能过滤**：每次调用时先过滤掉失效的 key
4. **随机选择**：从剩余可用的 key 池里随机选择
5. **自动清理**：定期清理过期的失效记录
6. **智能错误处理**：根据不同的 HTTP 状态码设置不同的拉黑时长

### 关键参数
- **清理间隔**：1小时清理一次过期记录
- **智能拉黑时长**：
  - 432 状态码：拉黑一周（7天）
  - 429 状态码：拉黑1小时（Too Many Requests）
  - 401/403 状态码：拉黑1天（认证/权限错误）
  - 其他4xx错误：拉黑2小时
  - 5xx服务器错误：拉黑30分钟
  - 网络错误：拉黑1小时

## 实现计划

### ✅ 已完成功能
1. **修改 `src/utils/model.ts`**
   - ✅ 扩展 `multiApiKeyPolling` 函数支持 key 池管理
   - ✅ 添加全局 key 状态管理
   - ✅ 实现 `markApiKeyFailed` 函数
   - ✅ 实现 `resetApiKeyStatus` 函数
   - ✅ 实现 `getApiKeyStatusSummary` 函数
   - ✅ 实现智能错误码拉黑时长机制

2. **修改 `src/hooks/useWebSearch.ts`**
   - ✅ 更新各搜索提供商的 key 获取逻辑
   - ✅ 添加错误处理机制
   - ✅ 添加 key 状态管理功能

### 第二阶段：错误处理优化
1. **修改 `src/utils/deep-research/search.ts`**
   - 在搜索函数中添加状态码检查
   - 实现 key 失败标记逻辑
   - 优化错误信息返回

### 第三阶段：监控和管理
1. **添加监控功能**
   - Key 使用统计
   - 失败率监控
   - 健康状态检查

## 修改文件清单

### 必须修改的文件
1. `src/utils/model.ts` - 核心逻辑实现
2. `src/hooks/useWebSearch.ts` - 调用处更新
3. `src/utils/deep-research/search.ts` - 错误处理

### 可选修改的文件
1. `src/components/Setting.tsx` - 添加 key 状态显示
2. `src/store/setting.ts` - 添加管理功能

## 向后兼容性

- 保持现有 `multiApiKeyPolling` 函数的向后兼容
- 不传入 provider 参数时使用原有逻辑
- 现有调用方式不受影响

## 测试计划

### 单元测试
1. Key 池初始化和状态管理
2. 失效 key 标记和恢复
3. 多 provider 隔离测试
4. 边界条件测试

### 集成测试
1. 各搜索提供商的 key 轮询
2. 失败重试机制
3. 冷却时间验证

### 性能测试
1. 多 key 情况下的性能影响
2. 内存使用情况
3. 定时清理效率

## 部署计划

### 开发环境
1. 功能开发和单元测试
2. 集成测试和性能优化
3. 代码审查和文档完善

### 生产环境
1. 灰度发布
2. 监控和日志
3. 性能监控和优化

## 风险评估

### 技术风险
1. 内存泄漏风险（全局变量管理）
2. 并发安全问题
3. 性能影响

### 业务风险
1. 现有功能影响
2. 用户体验变化
3. 配置复杂度增加

## 成功标准

1. ✅ 支持多 key 轮询
2. ✅ 失败 key 自动标记和恢复
3. ✅ 所有搜索提供商兼容
4. ✅ 向后兼容性保持
5. ✅ 性能影响最小化
6. ✅ 错误处理完善

## 后续优化

1. **智能负载均衡**：基于响应时间和成功率选择最优 key
2. **动态配置**：支持运行时动态添加/删除 key
3. **监控面板**：可视化 key 使用状态和性能指标
4. **告警机制**：key 池耗尽或异常率过高时的告警

---

**文档创建时间**：2025-01-29  
**最后更新时间**：2025-01-29  
**预计完成时间**：TBD  
**负责人**：开发团队

## 实际错误案例分析

### Tavily 432 错误
```json
{
  "status": 432,
  "statusText": "",
  "error": "This request exceeds your plan's set usage limit. Please upgrade your plan or contact support@tavily.com"
}
```

**处理策略**：
- ✅ 状态码 432 已正确识别并拉黑一周
- ✅ 错误信息包含使用限制超出的明确说明
- ✅ 适合长时间拉黑，因为需要等待计划重置或升级

### 其他已知错误类型
- **429 Too Many Requests** - 短时间内请求过多，拉黑1小时
- **401/403 Unauthorized/Forbidden** - 认证失败，拉黑1天
- **5xx Server Errors** - 服务器问题，拉黑30分钟
- **网络错误** - 连接问题，拉黑1小时