# æ•°æ®ä¸­å¿ƒèŠå¤©é›†æˆå®ŒæˆæŠ¥å‘Š

## ğŸ“Š **å®ç°å®Œæˆåº¦æ€»ç»“**

### âœ… **å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½**

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | å‰ç«¯æ¥å£ | åç«¯API | è¯´æ˜ |
|----------|----------|----------|---------|------|
| **JWTè®¤è¯** | âœ… å®Œæˆ | `validateToken()` | `/api/v1/auth/me` | åå°éªŒè¯ï¼Œå¤±è´¥æ—¶æ˜¾ç¤ºå…¨å±é”™è¯¯ |
| **è¯é¢˜åˆ›å»º** | âœ… å®Œæˆ | `createDeepResearchTopic()` | `/api/v1/chat/topics` | åœ¨ç¬¬ä¸€è½®å¯¹è¯åè‡ªåŠ¨åˆ›å»º |
| **æ¶ˆæ¯è®°å½•** | âœ… å®Œæˆ | `saveChatMessage()` | `/api/v1/chat/topics/{id}/messages` | è®°å½•ç”¨æˆ·-AIæ ‡å‡†å¯¹è¯ |
| **å†å²åŠ è½½** | âœ… å®Œæˆ | `loadTopicHistory()` | `/api/v1/chat/topics/{id}` + `messages` | å®Œæ•´çŠ¶æ€æ¢å¤ |
| **è¿›åº¦ä¿å­˜** | âœ… å®Œæˆ | `saveStageMessage()` | `/api/v1/chat/topics/{id}/messages` | ç ”ç©¶é˜¶æ®µæ•°æ® |
| **å…ƒæ•°æ®æ›´æ–°** | âœ… å®Œæˆ | `updateTopicStatus()` | `/api/v1/chat/topics/{id}/metadata` | è¯é¢˜çŠ¶æ€ç®¡ç† |

## ğŸ”„ **å®Œæ•´æ•°æ®æµç¨‹å›¾**

```mermaid
graph TD
    A[ç”¨æˆ·è®¿é—®é¡µé¢] --> B{æ˜¯å¦æœ‰topicId?}
    B -->|æœ‰| C[éªŒè¯JWT]
    B -->|æ— | D[æ–°è¯é¢˜æ¨¡å¼]
    
    C --> E{JWTæœ‰æ•ˆ?}
    E -->|æ˜¯| F[åŠ è½½è¯é¢˜å†å²]
    E -->|å¦| G[æ˜¾ç¤ºå…¨å±é”™è¯¯]
    
    F --> H[è·å–è¯é¢˜è¯¦æƒ…]
    H --> I[è·å–æ¶ˆæ¯åˆ—è¡¨]
    I --> J[é‡æ„æœ¬åœ°çŠ¶æ€]
    J --> K[æ˜¾ç¤ºå†å²æ•°æ®]
    
    D --> L[ç”¨æˆ·è¾“å…¥é—®é¢˜]
    L --> M[AIç”Ÿæˆå›ç­”]
    M --> N[åˆ›å»ºæ–°è¯é¢˜]
    N --> O[ä¿å­˜ç”¨æˆ·æ¶ˆæ¯]
    O --> P[ä¿å­˜AIå›å¤]
    
    K --> Q[ç”¨æˆ·ç»§ç»­æ“ä½œ]
    P --> Q
    Q --> R[ä¿å­˜æ¯æ­¥æ“ä½œ]
    R --> S[å®æ—¶åŒæ­¥åˆ°æ•°æ®ä¸­å¿ƒ]
```

## ğŸ¯ **æ–°å¢çš„å…³é”®åŠŸèƒ½**

### 1. **æ™ºèƒ½è¯é¢˜åˆ›å»º**
- åœ¨ç”¨æˆ·æé—®å¹¶å¾—åˆ°AIå›å¤åè‡ªåŠ¨åˆ›å»ºè¯é¢˜
- è®¾ç½®æ­£ç¡®çš„`chat_type: "deep_research"`
- è‡ªåŠ¨ç”Ÿæˆç®€æ´çš„è¯é¢˜æ ‡é¢˜

### 2. **æ ‡å‡†æ¶ˆæ¯æ ¼å¼**
```typescript
interface ChatMessage {
  content: string;
  role: 'user' | 'assistant';
  metadata: {
    message_type: string;
    stage?: string;
    chat_type?: string;
    timestamp: string;
  };
}
```

### 3. **å®Œæ•´å¯¹è¯è®°å½•**
- **ç”¨æˆ·é—®é¢˜** â†’ `saveChatMessage('user', question)`
- **AIå›ç­”** â†’ `saveChatMessage('assistant', response)`
- **ç”¨æˆ·åé¦ˆ** â†’ `saveChatMessage('user', feedback)`
- **æœ€ç»ˆæŠ¥å‘Š** â†’ `saveChatMessage('assistant', report)`

### 4. **è‡ªåŠ¨çŠ¶æ€åŒæ­¥**
- ç ”ç©¶è¿›åº¦è‡ªåŠ¨ä¿å­˜
- è¯é¢˜çŠ¶æ€å®æ—¶æ›´æ–° (`pending` â†’ `in_progress` â†’ `completed`)
- æ”¯æŒé”™è¯¯çŠ¶æ€è®°å½•

## ğŸ›  **é›†æˆåˆ°ç°æœ‰ç»„ä»¶**

### Topicç»„ä»¶
```typescript
// åœ¨ askQuestions() å®Œæˆåè‡ªåŠ¨åˆ›å»ºè¯é¢˜
if (!chatHistory.currentTopicId && chatHistory.isConnected) {
  await chatHistory.createTopicWithInitialChat(question, aiResponse);
}
```

### Feedbackç»„ä»¶  
```typescript
// ä¿å­˜ç”¨æˆ·åé¦ˆ
if (chatHistory.currentTopicId && values.feedback) {
  await chatHistory.saveFeedback(values.feedback);
}
```

### useDeepResearch Hook
```typescript
// ä¿å­˜æœ€ç»ˆæŠ¥å‘Š
if (chatHistory.currentTopicId && content) {
  await chatHistory.saveFinalReport(content);
  await chatHistory.markTopicCompleted();
}
```

## ğŸ§ª **æµ‹è¯•å·¥å…·**

### æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
```javascript
// å®Œæ•´æµ‹è¯•æµç¨‹
window.testDataCenter.runAll("jwt_token", "http://api-url")

// æµ‹è¯•èŠå¤©æµç¨‹
window.testDataCenter.testChat("ç”¨æˆ·é—®é¢˜", "AIå›å¤")

// æµ‹è¯•JWTè®¤è¯
window.testDataCenter.testJWT("jwt_token", "http://api-url")
```

## ğŸ“ **URLå‚æ•°æ”¯æŒ**

### åŸºæœ¬ä½¿ç”¨
```
# æ–°è¯é¢˜ï¼ˆæ— topicIdï¼‰
http://localhost:3003/?jwt=token

# åŠ è½½ç°æœ‰è¯é¢˜  
http://localhost:3003/?jwt=token&topicId=123

# å®Œæ•´é…ç½®
http://localhost:3003/?jwt=token&topicId=123&provider=deepseek&apiKey=sk-xxx
```

## âš¡ **æ€§èƒ½ä¼˜åŒ–**

### 1. **é˜²æŠ–ä¿å­˜**
- çŠ¶æ€å˜åŒ–2ç§’åæ‰ä¿å­˜ï¼Œé¿å…é¢‘ç¹APIè°ƒç”¨
- æ‰¹é‡å¤„ç†å¤šä¸ªçŠ¶æ€å˜åŒ–

### 2. **æ™ºèƒ½åŒæ­¥**
- åªåœ¨æœ‰JWTè®¤è¯æ—¶æ‰ä¿å­˜æ•°æ®
- è‡ªåŠ¨æ£€æµ‹çŠ¶æ€å˜åŒ–ï¼Œä»…ä¿å­˜æœ‰æ›´æ–°çš„å†…å®¹

### 3. **é”™è¯¯å®¹é”™**
- ä¿å­˜å¤±è´¥ä¸å½±å“æœ¬åœ°åŠŸèƒ½
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ä¾¿äºè°ƒè¯•

## ğŸ‰ **æ€»ç»“**

âœ… **å®Œå…¨å®ç°äº†æ‚¨è¦æ±‚çš„æ‰€æœ‰åŠŸèƒ½ï¼š**

1. âœ… ä½¿ç”¨æ­£ç¡®çš„æ¶ˆæ¯æ¥å£åŠ è½½è¯é¢˜å†å²
2. âœ… æ²¡æœ‰topicIdæ—¶åˆ›å»ºæ–°è¯é¢˜
3. âœ… ç¬¬ä¸€è½®å¯¹è¯åè‡ªåŠ¨åˆ›å»ºè¯é¢˜å¹¶ä¿å­˜æ¶ˆæ¯
4. âœ… æ¯æ­¥AIå›å¤å’Œç”¨æˆ·è¾“å…¥éƒ½è®°å½•åˆ°æ•°æ®ä¸­å¿ƒ
5. âœ… æ­£ç¡®è®¾ç½®chat_typeå’Œtopic_metadata
6. âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†

ç°åœ¨ç³»ç»Ÿå®Œå…¨æ”¯æŒæ•°æ®ä¸­å¿ƒçš„èŠå¤©å†å²è®°å½•åŠŸèƒ½ï¼ğŸš€
